<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web AR Machine Viewer</title>
    <!-- A-Frame and AR.js for WebAR -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.2.0/dist/aframe-extras.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Hide the default A-Frame canvas until everything is ready */
        .a-canvas {
            display: none;
            position: fixed !important;
        }
        .ar-cursor {
            transition: transform 0.3s ease-in-out;
        }
        .control-chip.active {
            background-color: white;
            color: black;
        }
         .control-chip.active .chip-text {
            color: black;
        }
    </style>
</head>

<body class="bg-black overflow-hidden">

    <!-- Start Screen -->
    <div id="start-screen" class="absolute inset-0 bg-gray-900 flex flex-col justify-center items-center z-20">
        <div class="text-center p-8 max-w-md">
            <h1 class="text-3xl font-bold text-white mb-4">Web AR Viewer</h1>
            <p class="text-gray-400 mb-8">Enter the URL of a .GLB or .GLTF model to view it in Augmented Reality.</p>
            <input id="model-url-input" type="url" placeholder="Enter model URL" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-4 py-3 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" value="https://storage.googleapis.com/xrand/users/beca66b4-73d8-49a4-ac89-e5e3c4a83d4e/models/1708330e-bc39-4c95-9934-6b0842053a6c.glb?X-Goog-Algorithm=GOOG4-RSA-SHA256&X-Goog-Credential=storage-admin%40total-now-441210-u5.iam.gserviceaccount.com%2F20250621%2Fauto%2Fstorage%2Fgoog4_request&X-Goog-Date=20250621T171055Z&X-Goog-Expires=3600&X-Goog-SignedHeaders=host&X-Goog-Signature=0a89634a9029e2695e9a64d94a1682eb51f481e765ce71c2b06f8a5ceb40d28c68705d3d6cb3349f6a2e864e522256a0af52e5e0cdb0fe0841ae782543349332202dc9b1da6e6043c544197c2bade6c7ccb05206c18d02588791359e6fcc0c2793179764cf915c844c46df8498b75f262229288d420954ed5ae6c0fa8a6653e7d304a08a369357ec01f51653172e50b67cd0e776d1454458bd6890b815e4c158c05567fe03caafdfa891cdc24e82ddd6438e1ff5455db80f0a1fb4dc7be361317313ffebaae662497e6160920c3e3a4dfb77f6ffaeeda2b1ff314dc47d27b48b6ed29d943513ae3b26919b5ba7db970e8f1c4288abadd640e4ba30d0f9f5e0e1">
            <button id="start-ar-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">Start AR Session</button>
        </div>
    </div>

    <a-scene
        id="ar-scene"
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
        renderer="antialias: true; alpha: true"
        gesture-detector
    >
        <a-assets>
            <!-- Model will be loaded dynamically -->
            <a-asset-item id="machine-model" src=""></a-asset-item>
        </a-assets>

        <!-- AR Camera and Cursor -->
        <a-camera gps-new-camera='gpsMinDistance: 5' look-controls="enabled: false" arjs-look-controls='smoothingFactor: 0.1'></a-camera>

        <!-- The 3D Machine Model -->
        <a-entity
            id="model-container"
            visible="false"
            scale="0.05 0.05 0.05" 
            rotation="0 0 0"
        >
            <a-gltf-model id="model" src="#machine-model" position="0 0 0"></a-gltf-model>
            
            <!-- Measurement visualizations, initially hidden -->
            <a-entity id="measurements" visible="false">
                 <!-- Using placeholder dimensions -->
                <a-text value="H: 1.80m" position="15 20 0" align="center" color="white" width="60"></a-text>
                <a-text value="W: 1.20m" position="0 40 0" align="center" color="white" width="60"></a-text>
                <a-text value="L: 0.80m" position="0 20 -12" align="center" color="white" width="60"></a-text>
            </a-entity>
        </a-entity>

        <!-- Ground plane reticle/cursor -->
        <a-entity id="reticle"
            visible="false"
            geometry="primitive: ring; radiusInner: 0.1; radiusOuter: 0.15;"
            material="color: white; shader: flat; opacity: 0.8;"
            rotation="-90 0 0"
            class="ar-cursor"
            animation__scale="property: scale; to: 1.2 1.2 1.2; dir: alternate; dur: 700; loop: true; easing: easeInOutSine;"
        >
        </a-entity>
    </a-scene>

    <!-- UI Overlay -->
    <div id="ui-overlay" class="absolute inset-0 flex-col justify-between p-4 text-white z-10 pointer-events-none hidden">
        
        <!-- Header -->
        <div class="flex justify-between items-center pt-4 px-2 pointer-events-auto">
            <button id="back-button" class="p-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </button>
            <div id="status-box" class="flex items-center bg-black/50 rounded-full px-4 py-2">
                <div id="loader" class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-3"></div>
                <span id="status-text" class="font-bold">Downloading Machine...</span>
            </div>
            <button id="reset-button" class="p-2">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M21 21v-5h-5"/></svg>
            </button>
        </div>

        <!-- Footer -->
        <div class="w-full flex justify-center pb-8 pointer-events-auto">
            <!-- Tap to Place Button -->
            <button id="place-button" class="bg-white text-black font-bold py-4 px-10 rounded-full shadow-lg transform transition-transform duration-300 scale-0 disabled:bg-gray-400">
                Tap to Place
            </button>
            
            <!-- Placed Controls -->
            <div id="placed-controls" class="hidden items-center space-x-4">
                <button id="measure-button" class="control-chip flex items-center bg-black/60 border border-white/30 rounded-full px-5 py-2.5 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 6H3"/><path d="M21 12H3"/><path d="M21 18H3"/><line x1="12" y1="3" x2="12" y2="21"/></svg>
                    <span class="chip-text ml-2 font-semibold">Measure</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        window.addEventListener('load', () => {
            // UI elements
            const startScreen = document.getElementById('start-screen');
            const startButton = document.getElementById('start-ar-button');
            const modelUrlInput = document.getElementById('model-url-input');
            
            const uiOverlay = document.getElementById('ui-overlay');
            const statusText = document.getElementById('status-text');
            const loader = document.getElementById('loader');
            const placeButton = document.getElementById('place-button');
            const resetButton = document.getElementById('reset-button');
            const measureButton = document.getElementById('measure-button');
            const placedControls = document.getElementById('placed-controls');
            const backButton = document.getElementById('back-button');

            // A-Frame elements
            const sceneEl = document.querySelector('#ar-scene');
            const modelAsset = document.getElementById('machine-model');
            const modelEl = document.getElementById('model');
            const modelContainer = document.getElementById('model-container');
            const measurements = document.getElementById('measurements');
            const reticle = document.getElementById('reticle');

            let isModelDownloaded = false;
            let isGroundDetected = false;
            let isModelPlaced = false;

            // --- State Update Function ---
            function updateUI() {
                if (!isModelDownloaded) {
                    statusText.textContent = 'Downloading Machine...';
                    loader.style.display = 'block';
                    placeButton.disabled = true;
                    placeButton.style.transform = 'scale(0)';
                } else if (!isGroundDetected) {
                    statusText.textContent = 'Point camera at a surface...';
                    loader.style.display = 'block';
                    placeButton.disabled = true;
                    placeButton.style.transform = 'scale(0)';
                } else if (!isModelPlaced) {
                    statusText.textContent = 'Surface found. Ready to place.';
                    loader.style.display = 'none';
                    placeButton.disabled = false;
                    placeButton.style.transform = 'scale(1)';
                    placedControls.classList.add('hidden');
                } else {
                    statusText.textContent = 'Machine Placed';
                    loader.style.display = 'none';
                    placeButton.style.transform = 'scale(0)';
                    placedControls.classList.remove('hidden');
                }
            }

            // --- Set up event listeners once ---
            
            // Listen for the actual model load event
            modelEl.addEventListener('model-loaded', () => {
                isModelDownloaded = true;
                updateUI();
            });

            // Listen for model loading errors
            modelEl.addEventListener('model-error', () => {
                statusText.textContent = 'Error: Could not load model.';
                loader.style.display = 'none';
            });
            
            sceneEl.addEventListener('ar-ready', () => {
                document.querySelector('.a-canvas').style.display = 'block';
            });
            
            sceneEl.addEventListener('ar-hit-test-start', () => {
                if (!isGroundDetected) {
                    isGroundDetected = true;
                    reticle.setAttribute('visible', true);
                    updateUI();
                }
            });

            sceneEl.addEventListener('ar-hit-test-achieved', (e) => {
                const hitPosition = e.detail.position;
                reticle.setAttribute('position', hitPosition);
            });

            // --- Control Button Logic ---

            function initializeAR() {
                // Reset states and update UI to show "Downloading..."
                isModelDownloaded = false;
                isGroundDetected = false;
                isModelPlaced = false;
                updateUI();
            }
            
            startButton.addEventListener('click', () => {
                const modelUrl = modelUrlInput.value;
                if (!modelUrl) {
                    alert('Please enter a valid model URL.');
                    return;
                }
                
                initializeAR();

                // Set model source to trigger the actual download
                modelAsset.setAttribute('src', modelUrl);

                // Hide start screen and show AR UI
                startScreen.style.display = 'none';
                uiOverlay.classList.remove('hidden');
                uiOverlay.classList.add('flex');
            });

            placeButton.addEventListener('click', () => {
                if(isGroundDetected && !isModelPlaced) {
                    const reticlePosition = reticle.getAttribute('position');
                    modelContainer.setAttribute('position', `${reticlePosition.x} ${reticlePosition.y} ${reticlePosition.z}`);
                    modelContainer.setAttribute('visible', true);
                    reticle.setAttribute('visible', false);
                    isModelPlaced = true;
                    updateUI();
                }
            });

            function resetScene() {
                modelContainer.setAttribute('visible', false);
                measurements.setAttribute('visible', false);
                measureButton.classList.remove('active');
                
                if (isGroundDetected) {
                    reticle.setAttribute('visible', true);
                }
                isModelPlaced = false;
            }

            resetButton.addEventListener('click', () => {
                resetScene();
                initializeAR();
                // Re-trigger download
                modelAsset.setAttribute('src', modelUrlInput.value);
            });

            backButton.addEventListener('click', () => {
                uiOverlay.classList.add('hidden');
                uiOverlay.classList.remove('flex');
                startScreen.style.display = 'flex';
                resetScene();
            });

            measureButton.addEventListener('click', () => {
                const isVisible = measurements.getAttribute('visible');
                measurements.setAttribute('visible', !isVisible);
                measureButton.classList.toggle('active');
            });
        });
    </script>
</body>
</html>
